name: Deploy Multi Sites

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Locate files (debug)
        run: |
          echo "Workspace: $GITHUB_WORKSPACE"
          ls -la
          find . -maxdepth 3 -type f -name "sites.csv" -print

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Netlify CLI
        run: |
          npm i -g netlify-cli
          netlify --version

      - name: Netlify whoami
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        run: |
          netlify --version
          netlify api getCurrentUser || true

      - name: List Netlify sites (debug)
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_TEAM: ${{ secrets.NETLIFY_TEAM }}
        run: |
          netlify sites:list --json || true

      - name: Deploy each site from CSV (auto-create if missing)
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }}
          SITES_CSV: ${{ vars.SITES_CSV }}
          PUBLIC_ROOT: ${{ vars.PUBLIC_ROOT }}
        run: |
          set -euo pipefail

          CSV_FILE="${SITES_CSV:-PT/sites.csv}"
          ROOT="${PUBLIC_ROOT:-PT}"
          CSV_PATH="$GITHUB_WORKSPACE/$CSV_FILE"

          echo "Using CSV: $CSV_PATH"
          test -f "$CSV_PATH" || { echo "CSV not found"; exit 1; }

          # Надёжная проверка наличия сайта по имени (без '--team')
          has_site () {
            local name="$1"
            JSON="$(netlify sites:list --json 2>/dev/null || echo '[]')"
            # Если CLI ничего не вернул, защитимся
            if [ -z "$JSON" ]; then JSON='[]'; fi
            echo "$JSON" | node -e "let d='';process.stdin.on('data',c=>d+=c);process.stdin.on('end',()=>{try{const a=JSON.parse(d||'[]');console.log(a.some(s=>s.name==='${name}'));}catch(e){console.log(false);}})"
          }

          while IFS=',' read -r folder site_name domain sitemap; do
            # пропуск заголовка/пустых/комментариев
            [ -z "${folder:-}" ] && continue
            [ "$folder" = "folder" ] && continue
            case "$folder" in \#*) continue;; esac

            SRC="${ROOT}/${folder}"
            echo "=== Site: '${site_name}'  domain='${domain}'  src='${SRC}'"

            if [ ! -d "$SRC" ]; then
              echo "WARN: dir not found: $SRC — пропускаю"
              continue
            fi

            # 1) создаём сайт при отсутствии
            if [ "$(has_site "$site_name")" != "true" ]; then
              echo "Site '${site_name}' not found — creating..."
              netlify sites:create --name "$site_name"
            else
              echo "Site '${site_name}' exists."
            fi

            # 2) деплой
            netlify deploy \
              --auth="$NETLIFY_AUTH_TOKEN" \
              --dir="$SRC" \
              --site="$site_name" \
              --prod

            # 3) пинг IndexNow
            if [ -n "${domain:-}" ]; then
              if [ -n "${sitemap:-}" ]; then
                URL="https://${domain}/${sitemap}"
              else
                URL="https://${domain}/"
              fi
              echo "Pinging IndexNow → $URL"
              curl -s -o /dev/null -w "IndexNow HTTP %{http_code}\n" \
                -H 'Content-Type: application/json' \
                -d "{\"host\":\"${domain}\",
                     \"key\":\"${INDEXNOW_KEY}\",
                     \"keyLocation\":\"https://${domain}/${INDEXNOW_KEY}.txt\",
                     \"urlList\":[\"${URL}\"]}" \
                https://api.indexnow.org/submit || true
            fi

            echo "=== Done: $site_name"
          done < "$CSV_PATH"

